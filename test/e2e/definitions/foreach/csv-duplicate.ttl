@base <http://example.org/pipeline/>.
@prefix code: <https://code.described.at/>.
@prefix p: <https://pipeline.described.at/>.
@prefix fs: <http://barnard59.zazuko.com/operations/core/fs/> .
@prefix base: <http://barnard59.zazuko.com/operations/base/> .

<> a p:Pipeline, p:Readable;
  p:variables [
    p:variable [ a p:Variable;
      p:name "filename" ;
      p:value "data/test.csv"
    ]
  ];
  p:steps [
    p:stepList
    (
      [ fs:createReadStream("${filename}"^^code:EcmaScriptTemplateLiteral) ]
      <parseCsv>
      [ base:forEach(<subPipeline>) ]
      <serializeJson>
    )
  ].

<parseCsv> a p:Step;
  code:implementedBy [ a code:EcmaScriptModule;
    code:link <file:operations/parseCsv.js#default>
  ].

<serializeJson> a p:Step;
  code:implementedBy [ a code:EcmaScriptModule;
    code:link <file:operations/serializeJson.js#default>
  ].

<subPipeline> a p:Pipeline, p:ReadableObjectMode, p:WritableObjectMode;
  p:steps [
    p:stepList (<duplicate>)
  ].

<duplicate> a p:Step;
  code:implementedBy [ a code:EcmaScriptModule;
    code:link <file:operations/duplicate.js#default>
  ].
